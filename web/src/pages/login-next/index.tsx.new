import SvgIcon from '@/components/svg-icon';
import { useAuth } from '@/hooks/auth-hooks';
import {
  useLogin,
  useLoginChannels,
  useLoginWithChannel,
  useRegister,
} from '@/hooks/use-login-request';
import { useSystemConfig } from '@/hooks/use-system-request';
import { rsaPsw } from '@/utils';
import { useEffect, useState } from 'react';
import { useTranslation } from 'react-i18next';
import { useNavigate } from 'react-router';

import { Button, ButtonLoading } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { cn } from '@/lib/utils';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import { z } from 'zod';
import FlipCard3D from './card';
import './index.less';

const Login = () => {
  const [title, setTitle] = useState('login');
  const navigate = useNavigate();
  const { login, loading: signLoading } = useLogin();
  const { register, loading: registerLoading } = useRegister();
  const { channels, loading: channelsLoading } = useLoginChannels();
  const { login: loginWithChannel, loading: loginWithChannelLoading } =
    useLoginWithChannel();
  const { t } = useTranslation('translation', { keyPrefix: 'login' });
  const [isLoginPage, setIsLoginPage] = useState(true);

  const loading =
    signLoading ||
    registerLoading ||
    channelsLoading ||
    loginWithChannelLoading;
  const { config } = useSystemConfig();
  const registerEnabled = config?.registerEnabled !== 0;

  const { isLogin } = useAuth();
  useEffect(() => {
    if (isLogin) {
      navigate('/');
    }
  }, [isLogin, navigate]);

  const handleLoginWithChannel = async (channel: string) => {
    await loginWithChannel(channel);
  };

  const changeTitle = () => {
    setIsLoginPage(title !== 'login');
    if (title === 'login' && !registerEnabled) {
      return;
    }

    setTimeout(() => {
      setTitle(title === 'login' ? 'register' : 'login');
    }, 200);
  };

  const FormSchema = z
    .object({
      nickname: z.string(),
      email: z
        .string()
        .email()
        .min(1, { message: t('emailPlaceholder') }),
      password: z.string().min(1, { message: t('passwordPlaceholder') }),
      remember: z.boolean().optional(),
    })
    .superRefine((data, ctx) => {
      if (title === 'register' && !data.nickname) {
        ctx.addIssue({
          path: ['nickname'],
          message: 'nicknamePlaceholder',
          code: z.ZodIssueCode.custom,
        });
      }
    });
  const form = useForm({
    defaultValues: {
      nickname: '',
      email: '',
      password: '',
      confirmPassword: '',
      remember: false,
    },
    resolver: zodResolver(FormSchema),
  });

  const onCheck = async (params: z.infer<typeof FormSchema>) => {
    try {
      const rsaPassWord = rsaPsw(params.password) as string;

      if (title === 'login') {
        const code = await login({
          email: `${params.email}`.trim(),
          password: rsaPassWord,
        });
        if (code === 0) {
          navigate('/');
        }
      } else {
        const code = await register({
          nickname: params.nickname,
          email: params.email,
          password: rsaPassWord,
        });
        if (code === 0) {
          setTitle('login');
        }
      }
    } catch (errorInfo) {
      console.log('Failed:', errorInfo);
    }
  };

  return (
    <div className="modern-login-page">
      {/* Clean white background */}
      <div className="modern-bg"></div>
      
      {/* Floating cards matching reference image */}
      <div className="floating-cards-wrapper">
        {/* Purple note - Call Editor */}
        <div className="floating-card-wrapper" style={{ top: '5%', left: '8%' }}>
          <div className="floating-card purple-note">
            <span>Call Editor</span>
          </div>
        </div>
        
        {/* Milton logo */}
        <div className="floating-card-wrapper" style={{ top: '3%', left: '35%' }}>
          <div className="floating-card logo-card">
            <span className="logo-icon">M</span>
            <span className="logo-text">Milton</span>
          </div>
        </div>
        
        {/* Yellow sticky note */}
        <div className="floating-card-wrapper" style={{ top: '5%', right: '5%' }}>
          <div className="floating-card yellow-sticky">
            <div className="sticky-title">Finish Paper</div>
            <div className="sticky-text">about women in finance</div>
          </div>
        </div>
        
        {/* Paper card - percentage */}
        <div className="floating-card-wrapper" style={{ top: '2%', left: '20%' }}>
          <div className="floating-card paper-card">
            <div className="paper-title">percentage</div>
            <div className="paper-excerpt">trading reduces men&apos;s net returns by 2.65 percentage points a year as opposed to..</div>
            <div className="paper-tags">
              <span className="tag empirical">● Empirical</span>
              <span className="tag theoretical">● Theoretical</span>
            </div>
          </div>
        </div>
        
        {/* Tag card - Overconfidence */}
        <div className="floating-card-wrapper" style={{ top: '15%', right: '15%' }}>
          <div className="floating-card tag-card">
            <span className="tag-indicator"></span>
            <span className="tag-name">Overconfidence</span>
          </div>
        </div>
        
        {/* Integrated paper */}
        <div className="floating-card-wrapper" style={{ top: '20%', right: '2%' }}>
          <div className="floating-card paper-card-small">
            <div className="paper-title-small">integrated</div>
            <div className="paper-excerpt-small">been employed to present a systematic..</div>
          </div>
        </div>
        
        {/* Blue note - Meet PhD Student */}
        <div className="floating-card-wrapper" style={{ bottom: '10%', left: '25%' }}>
          <div className="floating-card blue-note">
            <span>Meet PhD Student</span>
          </div>
        </div>
        
        {/* Paper large - Barber */}
        <div className="floating-card-wrapper" style={{ bottom: '15%', left: '2%' }}>
          <div className="floating-card paper-large">
            <div className="paper-header">Barber and Odean, 1998</div>
            <div className="paper-content">One of the most famous study on overconfidence in finance. Individual investors who trade more frequently earn..</div>
          </div>
        </div>
        
        {/* Paper large - Cain */}
        <div className="floating-card-wrapper" style={{ bottom: '20%', right: '2%' }}>
          <div className="floating-card paper-large">
            <div className="paper-header">Cain et al., 2015</div>
            <div className="paper-content">Revisit the classical question of overconfidence in market entry from</div>
          </div>
        </div>
        
        {/* Paper preview */}
        <div className="floating-card-wrapper" style={{ bottom: '5%', right: '15%' }}>
          <div className="floating-card paper-preview">
            <div className="preview-brand">Elsevier</div>
            <div className="preview-title">Overconfidence as a...</div>
            <div className="preview-author">Bill Proeger, Lukas Meys</div>
            <div className="preview-section">
              <div className="section-title">HIGHLIGHTS</div>
              <div className="section-line"></div>
              <div className="section-line short"></div>
              <div className="section-line"></div>
            </div>
          </div>
        </div>
      </div>

      {/* Center login form */}
      <div className="login-center">
        <FlipCard3D isLoginPage={isLoginPage}>
          <div className="login-card">
            <div className="login-header">
              <h1 className="lo
